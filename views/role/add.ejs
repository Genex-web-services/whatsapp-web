<%- include('../partials/head') %>
<%- include('../partials/sidebar') %>

<main class="dashboard-main bg-gray-100">
  <%- include('../partials/navbar') %>
  <div class="dashboard-main-body bg-gray-100 dark:bg-neutral-800 min-h-screen">
    <div class="card h-full p-0 rounded-xl border-0 overflow-hidden">
      <div class="card-body p-6">
        <div class="card border border-neutral-200 dark:border-neutral-600">
          <div class="card-body">
            <h6 class="text-base text-neutral-600 dark:text-neutral-200 mb-4">Role <%= Type %></h6>

            <form id="form" method="POST">
              <!-- Role Name -->
              <div class="mb-5">
                <label for="name" class="inline-block font-semibold text-neutral-600 dark:text-neutral-200 text-sm mb-2">
                  Role Name <span class="text-danger-600">*</span>
                </label>
                <input
                  type="text"
                  class="form-control rounded-lg"
                  id="name"
                  name="name"
                  value="<%= role?.name || '' %>"
                  required
                >
              </div>

              <!-- Role Code -->
              <div class="mb-5">
                <label for="roleCode" class="inline-block font-semibold text-neutral-600 dark:text-neutral-200 text-sm mb-2">
                  Role Code <span class="text-danger-600">*</span>
                </label>
                <input
                  type="text"
                  class="form-control rounded-lg"
                  id="roleCode"
                  name="roleCode"
                  value="<%= role?.roleCode || '' %>"
                  required
                  readonly
                >
              </div>

              <!-- Generate roleCode from name -->
              <script>
                (function () {
                  const nameInput = document.getElementById('name');
                  const codeInput = document.getElementById('roleCode');

                  nameInput.addEventListener('input', () => {
                    let raw = nameInput.value.trim().toLowerCase();
                    let sanitized = raw.replace(/[^a-z0-9]/g, '');
                    codeInput.value = sanitized;
                  });
                })();
              </script>

              <!-- Tenant ID -->
              <div class="mb-5">
                <label for="tenantId" class="inline-block font-semibold text-neutral-600 dark:text-neutral-200 text-sm mb-2">
                  Tenant ID <span class="text-danger-600">*</span>
                </label>
                <input
                  type="text"
                  class="form-control rounded-lg"
                  id="tenantId"
                  name="tenantId"
                  value="<%= role?.tenantId || tenantId %>"
                  <%= (currentRole?.[0]?.level === 0) ? '' : 'readonly' %>

                  required
                  >
                </div>

              <!-- Product ID -->
            <div class="mb-5">
  <label class="inline-block font-semibold text-neutral-600 dark:text-neutral-200 text-sm mb-2">
    Select Products <span class="text-danger-600">*</span>
  </label>

  <% product.forEach(prod => { %>
    <div class="mb-2 p-3 border border-neutral-300 dark:border-neutral-700 rounded-lg bg-white dark:bg-neutral-900 flex items-center space-x-2">
      <input
        type="checkbox"
        class="form-check-input product-checkbox"
        id="product_<%= prod._id %>"
        value="<%= prod._id %>"
        <%= role?.product_id?.includes(prod._id) ? 'checked' : '' %>
      >
      <label for="product_<%= prod._id %>" class="text-sm text-neutral-700 dark:text-neutral-300">
        <%= prod.product_name %>
      </label>
    </div>
  <% }) %>
</div>


              <!-- Permissions -->
              <div class="mb-5">
                <label class="inline-block font-semibold text-neutral-600 dark:text-neutral-200 text-sm mb-2">
                  Select Permissions
                </label>

                <% if (product && product.length) { %>
                  <% product.forEach(prod => { %>
                    <div class="mb-4 p-4 border border-neutral-300 dark:border-neutral-700 rounded-lg bg-white dark:bg-neutral-900">
                      <h6 class="text-sm font-semibold text-primary-600 mb-3">
                        <%= prod.product_name %>
                      </h6>
                      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
                        <% prod.permissions.forEach(perm => { %>
                          <div class="form-check flex items-center space-x-2">
                            <input
                              type="checkbox"
                              class="form-check-input permission-checkbox"
                              id="perm_<%= perm.pid %>"
                              value="<%= perm.pid %>"
                              <%= role?.permissions?.includes(perm.pid) ? 'checked' : '' %>
                            >
                            <label class="form-check-label text-sm text-neutral-700 dark:text-neutral-300" for="perm_<%= perm.pid %>">
                              <%= perm.pname %>
                            </label>
                          </div>
                        <% }) %>
                      </div>
                    </div>
                  <% }) %>
                <% } else { %>
                  <p class="text-sm text-gray-500">No permissions found for any product.</p>
                <% } %>
              </div>

              <!-- Default Role -->
              <div class="mb-5">
                <label class="inline-block font-semibold text-neutral-600 dark:text-neutral-200 text-sm mb-2">Is Default Role?</label>
                <div class="form-check">
                  <input type="checkbox" class="form-check-input" id="isDefault" name="isDefault" <%= role?.isDefault ? 'checked' : '' %> >
                  <label class="form-check-label" for="isDefault">Yes</label>
                </div>
              </div>

              <!-- Role Level -->
              <select class="form-control rounded-lg" id="level" name="level" required>
                <% if (currentRole?.[0]?.level === 0) { %>
                  <option value="0" <%= role?.level === 0 ? 'selected' : '' %>>Superadmin</option>
                  <option value="1" <%= role?.level === 1 ? 'selected' : '' %>>Partner</option>
                  <option value="2" <%= role?.level === 2 ? 'selected' : '' %>>Organization Admin</option>
                  <option value="3" <%= role?.level === 3 ? 'selected' : '' %>>User</option>
                <% } else { %>
                  <option value="2" <%= role?.level === 2 ? 'selected' : '' %>>Organization Admin</option>
                  <option value="3" <%= role?.level === 3 ? 'selected' : '' %>>User</option>
                <% } %>
              </select>


              <!-- Action Buttons -->
              <div class="flex items-center justify-center gap-3">
                <a href="/Roles-and-permission/list" class="border border-danger-600 bg-hover-danger-200 text-danger-600 text-base px-14 py-[11px] rounded-lg">
                  Cancel
                </a>
                <button type="submit" class="btn btn-primary border border-primary-600 text-base px-14 py-3 rounded-lg">
                  Save
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Submission script -->
 <script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('form');

    form.addEventListener('submit', async function (e) {
      e.preventDefault(); // ✅ prevent default form refresh

      const permissions = Array.from(document.querySelectorAll('.permission-checkbox:checked')).map(cb => cb.value);
const selectedProducts = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.value); // ✅ fix here
      const payload = {
        name: document.getElementById('name').value.trim(),
        roleCode: document.getElementById('roleCode').value.trim(),
        tenantId: document.getElementById('tenantId').value.trim(),
        product_id: selectedProducts,
        permissions,
        isDefault: document.getElementById('isDefault').checked,
        level: parseInt(document.getElementById('level').value)
      };

      try {
        const res = await fetch('/api/v1.0/roles-and-permission', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const result = await res.json();
        if (res.ok) {
          alert('Role saved successfully');
          window.location.href = "/roles-and-permission/list";
        } else {
          alert('Failed: ' + (result?.message || 'Unknown error'));
        }
      } catch (err) {
        console.error(err);
        alert('Something went wrong');
      }
    });
  });
</script>


  <%- include('../partials/footer') %>
  <%- include('../partials/script') %>
</main>
